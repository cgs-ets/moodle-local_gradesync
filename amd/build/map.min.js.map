{"version":3,"sources":["../src/map.js"],"names":["define","$","Log","Ajax","Map","rootel","courseid","self","prototype","main","changeClass","changeOverrideGroup","initMappedTo","on","e","preventDefault","select","saveMapping","loading","find","hide","aclass","val","show","areael","groupid","each","mappedto","data","change","assessment","closest","submitting","assessmentid","assessmentclass","gradeitem","call","methodname","args","externalclass","externalgradeid","gradeitemid","done","attr","fail","reason","error","debug","el","finished","setTimeout","removeClass","addClass","result","remove","append","fadeIn","delay","fadeOut","init","length","map"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Provides the local_gradesync/map module\r\n *\r\n * @package   local_gradesync\r\n * @category  output\r\n * @copyright 2020 Michael Vangelovski <michael.vangelovski@hotmail.com>\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/**\r\n * @module local_gradesync/map\r\n */\r\ndefine(['jquery', 'core/log', 'core/ajax'], \r\n    function($, Log, Ajax) {    \r\n    'use strict';\r\n\r\n    /**\r\n     * Initializes the map component.\r\n     */\r\n    function init(courseid) {\r\n        Log.debug('local_gradesync/map: initializing');\r\n\r\n        var rootel = $('#local_gradesync-map-root');\r\n\r\n        if (!rootel.length) {\r\n            Log.error('local_gradesync/map: \\'#local_gradesync-map-root\\' not found!');\r\n            return;\r\n        }\r\n\r\n        var map = new Map(rootel, courseid);\r\n        map.main();\r\n    }\r\n\r\n    /**\r\n     * The constructor\r\n     *\r\n     * @constructor\r\n     * @param {jQuery} rootel\r\n     */\r\n    function Map(rootel, courseid) {\r\n        var self = this;\r\n        self.rootel = rootel;\r\n        self.courseid = courseid;\r\n    }\r\n\r\n    /**\r\n     * Run the map js.\r\n     *\r\n     */\r\n    Map.prototype.main = function () {\r\n        var self = this;\r\n\r\n        // Initialise UI.\r\n        self.changeClass();\r\n        self.changeOverrideGroup();\r\n        self.initMappedTo();\r\n\r\n        // Detect class change.\r\n        self.rootel.on('change', '#assessment-class', function(e) {\r\n            e.preventDefault();\r\n            self.changeClass();\r\n        });\r\n\r\n        // Add the selected value as an attr so that we can apply styles to the select.\r\n        //self.rootel.find('.gradeitems').each( function(i) {\r\n        //    $(this).attr('data-selected', select.val());\r\n        //});\r\n\r\n        // Detect mapping change.\r\n        self.rootel.on('change', '.gradeitems', function(e) {\r\n            e.preventDefault();\r\n            var select = $(this);\r\n            self.saveMapping(select);\r\n        });\r\n\r\n        // Detect group override change.\r\n        self.rootel.on('change', '#override-group', function(e) {\r\n            e.preventDefault();\r\n            self.changeOverrideGroup();\r\n        });\r\n\r\n    };\r\n\r\n    /**\r\n     * Load the mapping fields based on selected class.\r\n     *\r\n     */\r\n    Map.prototype.changeClass = function () {\r\n        var self = this;\r\n\r\n        // Hide/show the relevant class mappings.\r\n        self.loading(self.rootel);\r\n        self.rootel.find('.mappings-wrap').hide();\r\n        self.rootel.find('.assessment').hide();\r\n        var aclass = self.rootel.find('#assessment-class').val();\r\n        if (aclass && aclass != -1) {\r\n            self.rootel.find('.assessment[data-class=\"' + aclass + '\"]').show();\r\n            self.rootel.find('.mappings-wrap').show();\r\n        }\r\n        self.loading(self.rootel, 1);\r\n        // Reload group mappings.\r\n        self.changeOverrideGroup();\r\n    };\r\n\r\n    /**\r\n     * Load the mapping fields based on selected group.\r\n     *\r\n     */\r\n    Map.prototype.changeOverrideGroup = function () {\r\n        var self = this;\r\n\r\n        // Hide/show the relevant group mappings.\r\n        var areael = $('.overrides');\r\n        self.loading(areael);\r\n        self.rootel.find('.overrides .mappings').hide();\r\n        self.rootel.find('.overrides .assessment').hide();\r\n        var aclass = self.rootel.find('#assessment-class').val();\r\n        var groupid = self.rootel.find('#override-group').val();\r\n        if (aclass && groupid && aclass != -1 && groupid != -1) {\r\n            self.rootel.find('.overrides .assessment[data-groupid=\"' + groupid + '\"][data-class=\"' + aclass + '\"]').show();\r\n            self.rootel.find('.overrides .mappings').show();\r\n        }\r\n        self.loading(areael, 1);\r\n    };\r\n\r\n    /**\r\n     * Initialise the selected mappings.\r\n     *\r\n     */\r\n    Map.prototype.initMappedTo = function () {\r\n        var self = this;\r\n\r\n        self.rootel.find('.assessment').each(function() {\r\n            var mappedto = $(this).data('mappedto');\r\n            $(this).find('.gradeitems').val(mappedto).change();\r\n        });\r\n    };        \r\n\r\n    /**\r\n     * Load the mapping layout.\r\n     *\r\n     */\r\n    Map.prototype.saveMapping = function (select) {\r\n        var self = this;\r\n\r\n        var assessment = select.closest('.assessment');\r\n\r\n        self.submitting(assessment);\r\n\r\n        var assessmentid = assessment.data('id');\r\n        var assessmentclass = assessment.data('class');\r\n        var courseid = self.courseid;\r\n        var groupid = assessment.data('groupid');\r\n        var gradeitem = select.val();\r\n\r\n        Ajax.call([{\r\n            methodname: 'local_gradesync_save_mapping',\r\n            args: { \r\n                externalclass: assessmentclass,\r\n                externalgradeid: assessmentid,\r\n                courseid: courseid,\r\n                groupid: groupid,\r\n                gradeitemid: gradeitem\r\n            },\r\n            done: function(response) {\r\n                // Update the mappedto data attr.\r\n                //assessment.data('mappedto', gradeitem);\r\n                assessment.attr('data-mappedto', gradeitem);\r\n                self.submitting(assessment, 1, 1);\r\n            },\r\n            fail: function(reason) {\r\n                self.submitting(assessment, 1, 2);\r\n                Log.error('local_gradesync/map: failed to save mapping.');\r\n                Log.debug(reason);\r\n            }\r\n        }]);\r\n\r\n    };\r\n\r\n    /**\r\n     * Show/hide the loading state\r\n     *\r\n     */\r\n    Map.prototype.loading = function (el, finished) {\r\n        var self = this;\r\n\r\n        if (finished) {\r\n            setTimeout(function() {\r\n                el.removeClass('loading');\r\n            }, 200);\r\n        } else {\r\n            el.addClass('loading');\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Show/hide the submitting state\r\n     *\r\n     */\r\n    Map.prototype.submitting = function (assessment, finished, result) {\r\n        var self = this;\r\n\r\n        var assessmentid = assessment.data('id');\r\n\r\n        if (finished) {\r\n            assessment.find('#submitspinner-' + assessmentid).remove();\r\n            self.rootel.removeClass('submitting');\r\n            if (result == 1) {\r\n                assessment.append('<div style=\"display: none;\" id=\"result-' + assessmentid + '\" class=\"icon-result icon-result-success\"><i class=\"fa fa-check\" aria-hidden=\"true\"></i> Changes saved</div>');\r\n            } else if (result == 2) {\r\n                assessment.append('<div style=\"display: none;\" id=\"result-' + assessmentid + '\" class=\"icon-result icon-result-error\"><i class=\"fa fa-exclamation-triangle\" aria-hidden=\"true\"></i> Error saving changes</div>');\r\n            }\r\n            assessment.find('#result-' + assessmentid).fadeIn(200).delay(2000).fadeOut(200, function() {$(this).remove()});\r\n        } else {\r\n            self.rootel.addClass('submitting');\r\n            assessment.append('<div id=\"submitspinner-' + assessmentid + '\" class=\"spinner\"><div class=\"circle spin\"></div></div>');\r\n        }\r\n    };\r\n\r\n    return {\r\n        init: init\r\n    };\r\n});"],"file":"map.min.js"}