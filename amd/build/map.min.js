define(["jquery","core/log","core/ajax"],function(n,d,l){"use strict";function i(e,a){this.rootel=e,this.courseid=a}return i.prototype.main=function(){var i=this;i.changeClass(),i.changeOverrideGroup(),i.initMappedTo(),i.rootel.on("change","#assessment-class",function(e){e.preventDefault(),i.changeClass()}),i.rootel.on("change",".gradeitems",function(e){e.preventDefault();var a=n(this);i.saveMapping(a)}),i.rootel.on("change","#override-group",function(e){e.preventDefault(),i.changeOverrideGroup()})},i.prototype.changeClass=function(){var e=this;e.loading(e.rootel),e.rootel.find(".mappings-wrap").hide(),e.rootel.find(".assessment").hide();var a=e.rootel.find("#assessment-class").val();a&&-1!=a&&(e.rootel.find('.assessment[data-class="'+a+'"]').show(),e.rootel.find(".mappings-wrap").show()),e.loading(e.rootel,1),e.changeOverrideGroup()},i.prototype.changeOverrideGroup=function(){var e=this,a=n(".overrides");e.loading(a),e.rootel.find(".overrides .mappings").hide(),e.rootel.find(".overrides .assessment").hide();var i=e.rootel.find("#assessment-class").val(),s=e.rootel.find("#override-group").val();i&&s&&-1!=i&&-1!=s&&(e.rootel.find('.overrides .assessment[data-groupid="'+s+'"][data-class="'+i+'"]').show(),e.rootel.find(".overrides .mappings").show()),e.loading(a,1)},i.prototype.initMappedTo=function(){this.rootel.find(".assessment").each(function(){var e=n(this).data("mappedto");n(this).find(".gradeitems").val(e).change()})},i.prototype.saveMapping=function(e){var a=this,i=e.closest(".assessment");a.submitting(i);var s=i.data("id"),n=i.data("class"),o=a.courseid,t=i.data("groupid"),r=e.val();l.call([{methodname:"local_gradesync_save_mapping",args:{externalclass:n,externalgradeid:s,courseid:o,groupid:t,gradeitemid:r},done:function(e){a.submitting(i,1,1)},fail:function(e){a.submitting(i,1,2),d.error("local_gradesync/map: failed to save mapping."),d.debug(e)}}])},i.prototype.loading=function(e,a){a?setTimeout(function(){e.removeClass("loading")},200):e.addClass("loading")},i.prototype.submitting=function(e,a,i){var s=e.data("id");a?(e.find("#submitspinner-"+s).remove(),this.rootel.removeClass("submitting"),1==i?e.append('<div style="display: none;" id="result-'+s+'" class="icon-result icon-result-success"><i class="fa fa-check" aria-hidden="true"></i> Changes saved</div>'):2==i&&e.append('<div style="display: none;" id="result-'+s+'" class="icon-result icon-result-error"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Error saving changes</div>'),e.find("#result-"+s).fadeIn(200).delay(2e3).fadeOut(200,function(){n(this).remove()})):(this.rootel.addClass("submitting"),e.append('<div id="submitspinner-'+s+'" class="spinner"><div class="circle spin"></div></div>'))},{init:function(e){d.debug("local_gradesync/map: initializing");var a=n("#local_gradesync-map-root");a.length?new i(a,e).main():d.error("local_gradesync/map: '#local_gradesync-map-root' not found!")}}});