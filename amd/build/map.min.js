define(["jquery","core/log","core/ajax"],function(o,d,l){"use strict";function t(e,a){this.rootel=e,this.courseid=a}return t.prototype.main=function(){var t=this;t.changeClass(),t.changeOverrideGroup(),t.initMappedTo(),t.rootel.on("change","#assessment-class",function(e){e.preventDefault(),t.changeClass()}),t.rootel.on("change",".gradeitems",function(e){e.preventDefault();var a=o(this);t.saveMapping(a)}),t.rootel.on("change","#override-group",function(e){e.preventDefault(),t.changeOverrideGroup()}),t.checkAlerts()},t.prototype.changeClass=function(){var e=this;e.loading(e.rootel),e.rootel.find(".mappings-wrap").hide(),e.rootel.find(".assessment").hide();var a=e.rootel.find("#assessment-class").val();a&&-1!=a&&(e.rootel.find('.assessment[data-class="'+a+'"]').show(),e.rootel.find(".mappings-wrap").show()),e.loading(e.rootel,1),e.changeOverrideGroup()},t.prototype.changeOverrideGroup=function(){var e=this,a=o(".overrides");e.loading(a),e.rootel.find(".overrides .mappings").hide(),e.rootel.find(".overrides .assessment").hide();var t=e.rootel.find("#assessment-class").val(),i=e.rootel.find("#override-group").val();t&&i&&-1!=t&&-1!=i&&(e.rootel.find('.overrides .assessment[data-groupid="'+i+'"][data-class="'+t+'"]').show(),e.rootel.find(".overrides .mappings").show()),e.loading(a,1)},t.prototype.initMappedTo=function(){this.rootel.find(".assessment").each(function(){var e=o(this).data("mappedto");o(this).find(".gradeitems").val(e).change()})},t.prototype.saveMapping=function(e){var a=this,t=e.closest(".assessment");a.submitting(t);var i=t.data("id"),o=t.data("class"),s=a.courseid,n=t.data("groupid"),r=e.val();l.call([{methodname:"local_gradesync_save_mapping",args:{externalclass:o,externalgradeid:i,courseid:s,groupid:n,gradeitemid:r},done:function(e){t.data("mappedto",r),t.attr("data-mappedto",r),a.submitting(t,1,1),a.checkAlerts()},fail:function(e){a.submitting(t,1,2),d.error("local_gradesync/map: failed to save mapping."),d.debug(e)}}])},t.prototype.checkAlerts=function(e){this.rootel.find(".assessment").each(function(){var e=o(this);e.find(".alerts").html("");var a=e.data("mappedto");if("-1"==a)return console.log("not mapped..."),!1;var t=e.find('option[value="'+a+'"]');e.data("markoutof")!=t.data("markoutof")&&e.find(".alerts").append('<i class="fa fa-exclamation-triangle" aria-hidden="true" data-toggle="tooltip" title="\'Markoutof\' values do not match. Grades will not be synced."></i>')})},t.prototype.loading=function(e,a){a?setTimeout(function(){e.removeClass("loading")},200):e.addClass("loading")},t.prototype.submitting=function(e,a,t){var i=e.data("id");a?(e.find("#submitspinner-"+i).remove(),this.rootel.removeClass("submitting"),1==t?e.append('<div style="display: none;" id="result-'+i+'" class="icon-result icon-result-success"><i class="fa fa-check" aria-hidden="true"></i> Changes saved</div>'):2==t&&e.append('<div style="display: none;" id="result-'+i+'" class="icon-result icon-result-error"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Error saving changes</div>'),e.find("#result-"+i).fadeIn(200).delay(2e3).fadeOut(200,function(){o(this).remove()})):(this.rootel.addClass("submitting"),e.append('<div id="submitspinner-'+i+'" class="spinner"><div class="circle spin"></div></div>'))},{init:function(e){d.debug("local_gradesync/map: initializing");var a=o("#local_gradesync-map-root");a.length?new t(a,e).main():d.error("local_gradesync/map: '#local_gradesync-map-root' not found!")}}});