define(["jquery","core/log","core/ajax"],function(i,d,l){"use strict";function s(e,a){this.rootel=e,this.courseid=a}return s.prototype.main=function(){var s=this;s.changeClass(),s.changeOverrideGroup(),s.initMappedTo(),s.rootel.on("change","#assessment-class",function(e){e.preventDefault(),s.changeClass()}),s.rootel.on("change",".gradeitems",function(e){e.preventDefault();var a=i(this);s.saveMapping(a)}),s.rootel.on("change","#override-group",function(e){e.preventDefault(),s.changeOverrideGroup()}),s.checkAlerts()},s.prototype.changeClass=function(){var e=this;e.loading(e.rootel),e.rootel.find(".mappings-wrap").hide(),e.rootel.find(".assessment").hide();var a=e.rootel.find("#assessment-class").val();a&&-1!=a&&(e.rootel.find('.assessment[data-class="'+a+'"]').show(),e.rootel.find(".mappings-wrap").show()),e.loading(e.rootel,1),e.changeOverrideGroup()},s.prototype.changeOverrideGroup=function(){var e=this,a=i(".overrides");e.loading(a),e.rootel.find(".overrides .mappings").hide(),e.rootel.find(".overrides .assessment").hide();var s=e.rootel.find("#assessment-class").val(),t=e.rootel.find("#override-group").val();s&&t&&-1!=s&&-1!=t&&(e.rootel.find('.overrides .assessment[data-groupid="'+t+'"][data-class="'+s+'"]').show(),e.rootel.find(".overrides .mappings").show()),e.loading(a,1)},s.prototype.initMappedTo=function(){this.rootel.find(".assessment").each(function(){var e=i(this).data("mappedto");i(this).find(".gradeitems").val(e).change()})},s.prototype.saveMapping=function(e){var a=this,s=e.closest(".assessment");a.submitting(s);var t=s.data("id"),i=s.data("class"),n=a.courseid,o=s.data("groupid"),r=e.val();s.data("mappedto",r),s.attr("data-mappedto",r),l.call([{methodname:"local_gradesync_save_mapping",args:{externalclass:i,externalgradeid:t,courseid:n,groupid:o,gradeitemid:r},done:function(e){a.submitting(s,1,1),a.checkAlerts()},fail:function(e){a.submitting(s,1,2),d.error("local_gradesync/map: failed to save mapping."),d.debug(e)}}])},s.prototype.checkAlerts=function(e){this.rootel.find(".assessment").each(function(){var e=i(this);e.find(".alerts").html("");var a=e.data("mappedto");if("-1"!=a){var s=e.find('option[value="'+a+'"]');e.data("markoutof")!=s.data("markoutof")&&e.find(".alerts").append('<span style="font-size: 85%;"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> \'Markoutof\' values do not match. Grades will not be synced</span>')}else console.log("not mapped...")})},s.prototype.loading=function(e,a){a?setTimeout(function(){e.removeClass("loading")},200):e.addClass("loading")},s.prototype.submitting=function(e,a,s){var t=e.data("id");a?(e.find("#submitspinner-"+t).remove(),this.rootel.removeClass("submitting"),e.removeClass("submitting"),1==s?e.append('<div style="display: none;" id="result-'+t+'" class="icon-result icon-result-success"><i class="fa fa-check" aria-hidden="true"></i> Changes saved</div>'):2==s&&e.append('<div style="display: none;" id="result-'+t+'" class="icon-result icon-result-error"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Error saving changes</div>'),e.find("#result-"+t).fadeIn(200).delay(2e3).fadeOut(200,function(){i(this).remove()})):(e.find("#result-"+t).remove(),this.rootel.addClass("submitting"),e.addClass("submitting"),e.append('<div id="submitspinner-'+t+'" class="spinner"><div class="circle spin"></div></div>'))},{init:function(e){d.debug("local_gradesync/map: initializing");var a=i("#local_gradesync-map-root");a.length?new s(a,e).main():d.error("local_gradesync/map: '#local_gradesync-map-root' not found!")}}});